/**
 * gen_ccy_data.py - Generate List of Currencies for nvlps
 *
 *   Copyright (c) 2020 Asymworks, LLC.
 *
 *   The jt-currency library may be freely distributed under the terms of
 *   the BSD license.  For all licensing information, details and documentation:
 *   https://jadetree.io/api/jt-currency
 *
 * This script pulls data from ISO 4217 and xe.com to generate a list of
 * currencies that are currently in circulation.  This data is used to filter
 * the Unicode CLDR databases and limit the amount of data packaged for the
 * Nvlps frontend.
 *
 * Sources:
 * - {@link https://www.currency-iso.org/dam/downloads/lists/list_one.xml}
 * - {@link https://www.xe.com/iso4217.php}
 */

const { ArgumentParser } = require('argparse');
const { version } = require('../package.json');

var fs = require('fs');
var http = require('http');
var https = require('https');
var html_parser = require('node-html-parser');
var { template } = require('lodash');
var xml2js = require('xml2js');

const { generateList } = require('./ccy-list');
const { cldrVersion, loadLocaleData, localCurrencies } = require('./cldr');

const ts_data_template = `/**
 * Automatically generated by gen_ccy_data.py
 * @packageDocumentation
 * @internal
 */

// ISO 4217 data published <%= datePublished %>, retrieved <%= dateRetrieved %>
const ccyData: { [key: string]: { n: number; p: number } } = {
<% _.forOwn(currencies, function(data, key) { %>  <%= key %>: { n: <%= data.number %>, p: <%= data.precision %> },
<% }); %>};

// Unicode CLDR data version <%= cldrVersion %>, retrieved <%= dateRetrieved %>
const territoryCurrencies: { [key: string]: string } = {
<% _.forOwn(localCcy, function(data, key) { %>  <%= key %>: '<%= data %>',
<% }); %>};

export default ccyData;
export { territoryCurrencies };
`;

const ts_list_template = `/**
 * Automatically generated by gen_ccy_data.py
 * @packageDocumentation
 * @internal
 */

const ccyList: string[] = [
<% _.forOwn(currencies, function(data, key) { %>  '<%= key %>',
<% }); %>];

export default ccyList;
`;

const md_list_template = `
### List of Currency Codes supported by Jade Tree

| ISO 4216 | Currency Name |
| :------: | ------------- |
<%= currencyTable %>

> #### Sources
> https://www.currency-iso.org/dam/downloads/lists/list_one.xml
>
> https://www.xe.com/iso4217.php
>
> ISO 4216 data published on <%= datePublished %>,
> retrieved on <%= dateRetrieved %>
`;

async function main(arguments_) {
  const ccyList = await generateList();
  const localCcy = {};

  // Generate Local Currency List
  const ccyKeys = Object.keys(ccyList.currencies);
  Object.keys(localCurrencies).forEach((country) => {
    if (ccyKeys.includes(localCurrencies[country])) {
      localCcy[country] = localCurrencies[country];
    }
  });

  // Format output data
  let fmtData = '';
  if (arguments_.json) {
    fmtData = JSON.stringify(ccyList);
  } else {
    const options = {
      datePublished: ccyList.published,
      dateRetrieved: new Date().toISOString().slice(0, 10),
      currencies: ccyList.currencies,
      localCcy,
      cldrVersion,
    };

    fmtData = template(ts_data_template)(options);
  }

  // Write output data
  if (!arguments_.output || arguments_.output === '-') {
    process.stdout.write(`${fmtData}\n`);
  } else {
    fs.writeFile(arguments_.output, fmtData, (err) => {
      if (err) {
        throw err;
      }
      process.stderr.write(`Wrote currency data to ${arguments_.output}\n`);
    });
  }

  // Write output markdown
  if (arguments_.doc) {
    const ccyKeysDoc = Object.keys(ccyList.currencies).sort();
    const enData = loadLocaleData('en', ccyKeysDoc);

    const ccyTable = ccyKeysDoc
      .map((ccy) => `| \`${ccy}\` | ${enData.cn[ccy]} |`)
      .join('\n');

    const options = {
      datePublished: ccyList.published,
      dateRetrieved: new Date().toISOString().slice(0, 10),
      currencyTable: ccyTable,
    };

    const docData = template(md_list_template)(options);

    if (arguments_.doc === '-') {
      process.stdout.write(`${docData}\n`);
    } else {
      fs.writeFile(arguments_.doc, docData, (error) => {
        if (error) {
          throw error;
        }
        process.stderr.write(`Wrote documentation data to ${arguments_.doc}\n`);
      });
    }
  }
}

const parser = new ArgumentParser({
  description: 'Generates currency data and the list of supported currencies '
    + 'for the Jade Tree Currency library',
});

parser.add_argument('-v', '--version', { action: 'version', version });
parser.add_argument('--json', { action: 'store_true', help: 'write data in JSON format instead of a TypeScript module'});
parser.add_argument('-d', '--doc', { help: 'markdown file with the currency list'});
parser.add_argument('-o', '--output', { help: 'currency data output file (default writes to STDOUT)', default: '-' });

main(parser.parse_args());
